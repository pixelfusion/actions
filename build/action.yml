name: Build Docker Image
description: Build and push docker image
inputs:
  build-dir:
    description: 'Directory to run the build in'
    required: false
    default: ''
outputs:
  docker_image:
    description: "Docker image path generated by this action"
    value: ${{ steps.result.outputs.docker_image }}
  docker_image_latest:
    description: "Docker path to latest docker image"
    value: ${{ steps.result.outputs.docker_image_latest }}
  sentry_release:
    description: "Sentry release name"
    value: ${{ steps.result.outputs.sentry_release }}
runs:
  using: composite
  steps:
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        mask-aws-account-id: false
    - name: Login to Amazon ECR
      id: login-ecr-pf
      uses: aws-actions/amazon-ecr-login@v2
    - name: Build & Push
      shell: bash
      env:
        DOCKER_IMAGE: ${{ env.AWS_ACCOUNT }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.AWS_REPOSITORY }}
        SENTRY_RELEASE: ${{ env.SENTRY_PROJECT }}@${{ env.VERSION }}
      working-directory: ${{ inputs.build-dir }}
      run: |
        echo $VERSION > ./public/version.txt
        docker build -t $DOCKER_IMAGE:${{ env.VERSION }} .
        docker tag $DOCKER_IMAGE:${{ env.VERSION }} $DOCKER_IMAGE:latest
        docker push $DOCKER_IMAGE --all-tags
        echo "DOCKER_IMAGE=$DOCKER_IMAGE:${{ env.VERSION }}" >> $GITHUB_ENV
        echo "DOCKER_IMAGE_LATEST=$DOCKER_IMAGE:latest" >> $GITHUB_ENV
        echo "SENTRY_RELEASE=$SENTRY_RELEASE" >> $GITHUB_ENV
    - name: Logout of Amazon ECR
      shell: bash
      run: docker logout ${{ steps.login-ecr-pf.outputs.registry }}
    - name: Notify Slack
      uses: justinr636/github-action-slack-notify-build@v1
      if: failure()
      with:
        channel: ${{ env.SLACK_CHANNEL }}
        status: Failed to release
        color: '#dd0000'
    - id: result
      name: Set outputs
      shell: bash
      run: |
        echo "docker_image=${{ env.DOCKER_IMAGE }}" >> $GITHUB_OUTPUT
        echo "docker_image_latest=${{ env.DOCKER_IMAGE_LATEST }}" >> $GITHUB_OUTPUT
        echo "sentry_release=${{ env.SENTRY_RELEASE }}" >> $GITHUB_OUTPUT
